trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  imageNameBackend: 'codegen-backend'
  dockerRegistryServiceConnection: 'acr-connection'

stages:
- stage: Test
  jobs:
  - job: PythonUnitTests
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.11'
    - script: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pytest backend/tests/
      displayName: 'Run Backend Unit Tests'

- stage: Build
  dependsOn: Test
  jobs:
  - job: BuildDocker
    steps:
    - task: Docker@2
      inputs:
        containerRegistry: '$(dockerRegistryServiceConnection)'
        repository: '$(imageNameBackend)'
        command: 'buildAndPush'
        Dockerfile: 'backend/Dockerfile'
        tags: |
          $(Build.BuildId)
          latest

- stage: Deploy
  dependsOn: Build
  jobs:
  - deployment: DeployToAKS
    environment: 'dev'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: KubernetesManifest@0
            inputs:
              action: 'deploy'
              kubernetesServiceConnection: 'aks-connection'
              namespace: 'codegen-dev'
              manifests: |
                infrastructure/k8s/deployment.yaml
                infrastructure/k8s/service.yaml
